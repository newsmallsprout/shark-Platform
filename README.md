# MySQL to MongoDB ä¼ä¸šçº§æ•°æ®åŒæ­¥æœåŠ¡

[![Python 3.9+](https://img.shields.io/badge/python-3.9+-blue.svg)](https://www.python.org/downloads/)
[![Docker](https://img.shields.io/badge/docker-ready-green.svg)](https://www.docker.com/)
[![License](https://img.shields.io/badge/license-MIT-blue.svg)](LICENSE)

è¿™æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½ã€é«˜å®¹é”™çš„ **MySQL åˆ° MongoDB å®æ—¶æ•°æ®åŒæ­¥æœåŠ¡**ï¼Œä¸“ä¸ºé‡‘èçº§å®¡è®¡ç³»ç»Ÿä¸æ•°æ®æ¹–æ„å»ºã€‚æ”¯æŒ **å…¨é‡åŒæ­¥**ã€**Binlog å¢é‡åŒæ­¥ï¼ˆCDCï¼‰**ã€**æ•°æ®å¤šç‰ˆæœ¬æ§åˆ¶** ä»¥åŠ **æ— æŸè½¯åˆ é™¤**ã€‚

æœ¬æœåŠ¡é‡‡ç”¨ **Append-Onlyï¼ˆä»…è¿½åŠ ï¼‰** æ¶æ„è®¾è®¡ï¼Œç¡®ä¿æºç«¯ UPDATE/DELETE æ“ä½œç»ä¸ç¯¡æ”¹ MongoDB ä¸­çš„å†å²å¿«ç…§ï¼Œå®Œç¾æ»¡è¶³å®¡è®¡æº¯æºä¸æ—¶é—´æ—…è¡ŒæŸ¥è¯¢ï¼ˆTime-Travel Queryï¼‰éœ€æ±‚ã€‚

---

## âœ… æ”¯æŒç‰ˆæœ¬ (Compatibility)

| ç»„ä»¶ | æ”¯æŒç‰ˆæœ¬ | è¯´æ˜ |
| :--- | :--- | :--- |
| **MySQL** | 5.7, 8.0, 8.4 (LTS) | å¿…é¡»å¼€å¯ Binlog (`binlog_format=ROW`) |
| **MongoDB** | 4.4, 5.0, 6.0, 7.0+ | å»ºè®®ä½¿ç”¨å‰¯æœ¬é›† (Replica Set) æˆ–åˆ†ç‰‡é›†ç¾¤ |
| **Python** | 3.9+ | åŸºç¡€è¿è¡Œç¯å¢ƒ |
| **Docker** | 20.10+ | æ¨èéƒ¨ç½²æ–¹å¼ |

---

## ğŸš€ æ ¸å¿ƒç‰¹æ€§

- **åŒæ¨¡åŒæ­¥å¼•æ“**:
  - **å…¨é‡åŒæ­¥ (Full Sync)**: åŸºäºæ¸¸æ ‡çš„é«˜æ•ˆæ‰¹é‡å¯¼å‡ºï¼Œæ”¯æŒæ–­ç‚¹ç»­ä¼ ã€‚
  - **å¢é‡åŒæ­¥ (CDC)**: å®æ—¶è§£æ MySQL Binlog (ROW æ¨¡å¼)ï¼Œå®ç°æ¯«ç§’çº§å»¶è¿Ÿã€‚
- **æ•°æ®ä¸€è‡´æ€§ä¸å®‰å…¨**:
  - **é«˜ç²¾åº¦æ•°å€¼**: å…¨ç¨‹ä½¿ç”¨ `Decimal128` å¤„ç†é‡‘é¢å­—æ®µï¼Œæœç»æµ®ç‚¹æ•°ç²¾åº¦ä¸¢å¤±ã€‚
  - **å†™å…¥å¹‚ç­‰æ€§**: è‡ªåŠ¨æŠ‘åˆ¶ `E11000` é‡å¤é”®é”™è¯¯ï¼Œç¡®ä¿â€œè‡³å°‘ä¸€æ¬¡â€æŠ•é€’ä¸å¯¼è‡´æ•°æ®å´©æºƒã€‚
  - **æ•…éšœæ¢å¤**: è‡ªåŠ¨æŒä¹…åŒ– Binlog ä½ç‚¹ï¼Œé‡å¯åè‡ªåŠ¨æ— ç¼ç»­ä¼ ã€‚
- **å®¡è®¡ä¸æº¯æº (Append-Only)**:
  - **åŸºç¡€æ–‡æ¡£ä¸å¯å˜**: Base Collection ä»…å­˜å‚¨åˆå§‹å¿«ç…§ï¼Œåç»­ UPDATE/DELETE ç»ä¸ä¿®æ”¹åŸæ–‡æ¡£ã€‚
  - **ç‰ˆæœ¬é“¾ (Versioning)**: æ¯æ¬¡ UPDATE ç”Ÿæˆä¸€æ¡å…¨æ–°çš„ Version æ–‡æ¡£ï¼Œå®Œæ•´è®°å½•å˜æ›´å‰åçš„æ•°æ®å¿«ç…§ã€‚
  - **å¢“ç¢‘æœºåˆ¶ (Tombstone)**: DELETE æ“ä½œä»…è¿½åŠ ä¸€æ¡â€œåˆ é™¤æ ‡è®°â€æ–‡æ¡£ï¼Œå®ç°ç‰©ç†ç•™ç—•ã€é€»è¾‘åˆ é™¤ã€‚
- **ä¼ä¸šçº§å®‰å…¨**:
  - **é…ç½®åŠ å¯†**: æ•°æ®åº“è´¦å·å¯†ç åœ¨è½ç›˜å‰è‡ªåŠ¨ä½¿ç”¨ **AES-GCM (256-bit)** åŠ å¯†ã€‚
  - **å¯†é’¥éš”ç¦»**: æ¯ä¸ªåŒæ­¥ä»»åŠ¡è‡ªåŠ¨ç”Ÿæˆç‹¬ç«‹å¯†é’¥ (`./configs_keys/`)ï¼Œæœç»æ˜æ–‡æ³„éœ²ã€‚

---

## ğŸ— ç³»ç»Ÿæ¶æ„

### æ•°æ®æµå‘

```mermaid
flowchart LR
    MySQL[(MySQL Source)] -->|Binlog Stream| Syncer[Sync Engine]
    Syncer -->|Write Ops| Mongo[(MongoDB)]
    
    subgraph Mongo Storage Strategy
        Base[Base Collection]
        Version[Version Collection]
    end

    Syncer --> Base
    Syncer --> Version
```

### å­˜å‚¨æ¨¡å‹è®¾è®¡

1. **Base Document (åŸºå‡†å¿«ç…§)**
   - æ¥æºï¼šå…¨é‡åŒæ­¥é˜¶æ®µ æˆ– é¦–æ¬¡ INSERTã€‚
   - æ ‡è¯†ï¼š`_id` = `MySQL ä¸»é”®`ã€‚
   - ç‰¹æ€§ï¼š**ä¸å¯å˜ (Immutable)**ï¼Œä½œä¸ºå†å²å›æº¯çš„åŸºå‡†ç‚¹ã€‚

2. **Version Document (å†å²ç‰ˆæœ¬)**
   - æ¥æºï¼šUPDATE äº‹ä»¶ã€‚
   - ç»“æ„ï¼š`_id` (New ObjectId), `_base_id` (å…³è” Base), `_op` ("update"), `data` (è¡Œå¿«ç…§)ã€‚
   - ä½œç”¨ï¼šæ„å»ºå®Œæ•´çš„æ•°æ®å˜æ›´æ—¶é—´è½´ã€‚

3. **Tombstone Document (åˆ é™¤å¢“ç¢‘)**
   - æ¥æºï¼šDELETE äº‹ä»¶ã€‚
   - ç»“æ„ï¼š`_id` (New ObjectId), `_base_id` (å…³è” Base), `_op` ("delete"), `deleted_at`ã€‚
   - ä½œç”¨ï¼šä¿ç•™åˆ é™¤ç—•è¿¹ï¼Œæ”¯æŒæ•°æ®æ¢å¤ä¸å®¡è®¡ã€‚

---

## ğŸ›  å¿«é€Ÿéƒ¨ç½²

### 1. å¯åŠ¨æœåŠ¡ (Docker Compose)

```bash
# å…‹éš†é¡¹ç›®
git clone <repo_url>
cd mysql-to-mongo

# å¯åŠ¨æœåŠ¡é›†ç¾¤
docker-compose up -d --build
```

### 2. éªŒè¯çŠ¶æ€
- **API æ–‡æ¡£**: [http://localhost:8000/docs](http://localhost:8000/docs)
- **MongoDB**: `mongodb://localhost:27018`

### 3. æŒä¹…åŒ–ç›®å½•è¯´æ˜
åŠ¡å¿…å¦¥å–„ä¿ç®¡ä»¥ä¸‹ç›®å½•ï¼š
- `./configs`: å­˜å‚¨ **åŠ å¯†å** çš„ä»»åŠ¡é…ç½®æ–‡ä»¶ã€‚
- `./configs_keys`: å­˜å‚¨ä»»åŠ¡å¯¹åº”çš„ **è§£å¯†å¯†é’¥** (ğŸ”´ **æ ¸å¿ƒæœºå¯†ï¼Œè¯·å¤‡ä»½**)ã€‚
- `./state`: å­˜å‚¨ Binlog åŒæ­¥ä½ç‚¹ï¼Œç”¨äºæ–­ç‚¹ç»­ä¼ ã€‚

---

## ğŸ”’ å®‰å…¨é…ç½®ä¸ä»»åŠ¡ç®¡ç†

æ‰€æœ‰é€šè¿‡ API æäº¤çš„æ•°æ®åº“å‡­æ®å‡ä¼šåœ¨å†…å­˜ä¸­å³æ—¶åŠ å¯†ï¼Œç£ç›˜ä¸Šä»…å­˜å‚¨å¯†æ–‡ã€‚

### åˆ›å»ºåŒæ­¥ä»»åŠ¡

**POST** `/tasks/start`

```json
{
  "task_id": "trade_order_sync",
  "mysql_conf": {
    "host": "mysql_source",
    "port": 3306,
    "user": "root",
    "password": "strong_password",
    "database": "order_db"
  },
  "mongo_conf": {
    "host": "mongo1",
    "port": 27017,
    "user": "root",
    "password": "root",
    "database": "data_lake",
    "auth_source": "admin"
  },
  "table_map": {
    "t_orders": "orders_collection"
  },
  "pk_field": "id",
  
  // æ ¸å¿ƒé…ç½®ï¼šå¼€å¯è¿½åŠ æ¨¡å¼
  "delete_append_new_doc": true,
  "update_insert_new_doc": true,
  
  // è‡ªåŠ¨è¡¨ç»“æ„å‘ç°
  "auto_discover_new_tables": true
}
```

---

## ğŸ§© ç›®å½•ç»“æ„

```text
.
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ api/                 # REST API æ¥å£å±‚
â”‚   â”œâ”€â”€ core/                # æ ¸å¿ƒç»„ä»¶ (åŠ å¯†, é…ç½®ç®¡ç†, æ—¥å¿—)
â”‚   â”œâ”€â”€ sync/                # åŒæ­¥å¼•æ“
â”‚   â”‚   â”œâ”€â”€ worker.py        # ä¸»åŒæ­¥è¿›ç¨‹ (Full + Inc Loop)
â”‚   â”‚   â”œâ”€â”€ mongo_writer.py  # æ‰¹é‡å†™å…¥ä¸é”™è¯¯æŠ‘åˆ¶å¤„ç†
â”‚   â”‚   â””â”€â”€ convert.py       # ç±»å‹è½¬æ¢ (Decimal/Date)
â”‚   â””â”€â”€ main.py              # æœåŠ¡å…¥å£
â”œâ”€â”€ configs/                 # [æŒä¹…åŒ–] åŠ å¯†ä»»åŠ¡é…ç½®
â”œâ”€â”€ configs_keys/            # [æŒä¹…åŒ–] ä»»åŠ¡å¯†é’¥
â”œâ”€â”€ state/                   # [æŒä¹…åŒ–] Binlog ä½ç‚¹
â”œâ”€â”€ Dockerfile               # ç”Ÿäº§çº§é•œåƒæ„å»ºæ–‡ä»¶
â””â”€â”€ docker-compose.yml       # æœ¬åœ°å¼€å‘ç¼–æ’
```

---

## âš ï¸ è¿ç»´æŒ‡å—

1. **ä»»åŠ¡æ¢å¤**:
   - æœåŠ¡é‡å¯æ—¶ï¼Œä¼šè‡ªåŠ¨åŠ è½½ `configs/` ä¸‹çš„ä»»åŠ¡å¹¶è§£å¯†ï¼Œè¯»å– `state/` ä½ç‚¹è‡ªåŠ¨æ¢å¤åŒæ­¥ã€‚
   - **å¼ºåˆ¶é‡è·‘å…¨é‡**: åœæ­¢ä»»åŠ¡åï¼Œåˆ é™¤ `state/<task_id>.json` å¹¶é‡å¯å³å¯ã€‚

2. **Schema å˜æ›´**:
   - æ”¯æŒ MySQL æ–°å¢åˆ—çš„è‡ªåŠ¨è¯†åˆ«ä¸åŒæ­¥ (éœ€å¼€å¯ `unknown_col_fix_enabled`)ã€‚
   - æ”¯æŒæ–°è¡¨çš„è‡ªåŠ¨å‘ç°ä¸åŒæ­¥ (éœ€å¼€å¯ `auto_discover_new_tables`)ã€‚

3. **æ—¥å¿—ç›‘æ§**:
   - æŸ¥çœ‹å®æ—¶æ—¥å¿—: `docker logs -f syncer_app`
   - **æ³¨æ„**: `E11000` (Duplicate Key) é”™è¯¯ä¼šè¢«è§†ä¸ºå¹‚ç­‰æˆåŠŸè€Œåœ¨æ—¥å¿—ä¸­æŠ‘åˆ¶ï¼Œè¿™æ˜¯æ­£å¸¸è¡Œä¸ºã€‚

---

## ğŸ“œ å¼€æºåè®®

MIT License. è¯¦æƒ…è¯·å‚é˜… [LICENSE](LICENSE) æ–‡ä»¶ã€‚
